:PROPERTIES:
:ID:       78c3b40b-4600-4264-bb9a-810131987771
:END:
#+title: Guix

https://systemcrafters.cc/craft-your-system-with-guix/

* Various commands
  #+begin_src sh
  guix package --list-generations

  # list installed packages
  guix package --list-installed

  # export list installed packages
  guix package --export-manifest > manifest.scm
  # reproduce, i.e. reinstall packages
  guix package --manifest=manifest.scm

  guix package --roll-back
  guix package --remove python --install guile
  guix package -r       python  -i       guile
  guix install                           guile
  # install specific package version
  guix package                 --install bat@0.18.3

  # guix package -i mycli --with-latest=mycli

  guix package --search=hello

  # systemctl status guix-daemon # on a foreign host

  guix describe --list-formats
  guix describe vim --format=channels

  guix system describe

  # lists the currently defined services
  sudo herd status

  # `guix system reconfigure configuration.scm` may produce:
  #   guix system: error: symlink: Permission denied: "/var/guix/profiles/system-2-link.new"
  # so try with sudo -E / --preserve-env
  sudo -E guix system reconfigure configuration.scm
  #+end_src

* [[https://guix.gnu.org/manual/en/html_node/Package-Transformation-Options.html][Package Transformation Options]]
  #+BEGIN_SRC sh
  guix package --with-source=source
  guix package --with-source=package=source
  guix package --with-source=package@version=source
  guix package --with-input=package=replacement
  guix package --with-graft=package=replacement
  guix package --with-debug-info=package
  guix package --with-c-toolchain=package=toolchain
  guix package --with-git-url=package=url
  guix package --with-branch=package=branch
  guix package --with-commit=package=commit
  guix package --with-patch=package=file
  guix package --with-latest=package
  guix package --without-tests=package
  #+END_SRC

* [[https://guix.gnu.org/manual/en/html_node/Upgrading-Guix.html][Upgrade Guix]]
** On foreign system (e.g. Ubuntu)
  #+begin_src sh
  sudo --login guix pull
  systemctl restart guix-daemon.service
  #+end_src
** On Guix System
  #+begin_src sh
  guix pull
  guix upgrade
  # not working: guix system reconfigure
  sudo herd restart guix-daemon
  # see also
  sudo herd status guix-daemon
  #+end_src

* Remove Guix from Ubuntu
  #+begin_src sh
  sudo systemctl stop guix-daemon.service
  sudo rm -rf /gnu
  sudo rm -rf /var/guix/
  sudo rm -rf /etc/guix/
  #+end_src

* [[https://guix.gnu.org/manual/en/html_node/Using-the-Configuration-System.html][System Configuration]]
  #+begin_src sh
  guix system describe

  # time-machine - run commands from a different revision
  # Usage: guix time-machine [OPTION] -- COMMAND ARGS...
  # Execute COMMAND ARGS... in an older version of Guix.

  # search for existing service type 'console'
  guix system search console
  #+end_src

* [[https://guix.gnu.org/cookbook/en/html_node/Basic-setup-with-manifests.html][Basic setup with manifests]]
  #+begin_src sh
  # see also guix package --export-manifest
  guix package --list-profiles
  GUIX_EXTRA_PROFILES=$HOME/.guix-extra-profiles
  mkdir -p "$GUIX_EXTRA_PROFILES"/my-project # if it does not exist yets
  guix package --manifest=$HOME/guix-my-project-manifest.scm \
               --profile="$GUIX_EXTRA_PROFILES"/my-project/my-project

  guix package -p "$GUIX_EXTRA_PROFILES"/my-project/my-project --list-installed
  #+end_src

  Add to ~/.bashrc (adding to ~/.bash_profile doesn't work):
  #+begin_src sh
  GUIX_EXTRA_PROFILES=$HOME/.guix-extra-profiles
  for i in $GUIX_EXTRA_PROFILES/*; do
    profile=$i/$(basename "$i")
    if [ -f "$profile"/etc/profile ]; then
      GUIX_PROFILE="$profile"
      . "$GUIX_PROFILE"/etc/profile
    fi
    unset profile
  done
  #+end_src

* [[https://guix.gnu.org/manual/en/html_node/Running-Guix-in-a-VM.html][Guix in a VM: SSH access]]
  Edit the /run/current-system/configuration.scm
  #+begin_src guile
  (service openssh-service-type
  (openssh-configuration
  (permit-root-login 'without-password)))
  #+end_src

  #+begin_src sh
  guix system reconfigure /path/to/configuration.scm
  ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 10022 guest@localhost
  #+end_src

  #+begin_src sh
  guix deploy /path/to/some/file.scm
  #+end_src

* Sending patches
  [[https://git.savannah.gnu.org/cgit/guix.git/tree/doc/guix.texi][Guix Documentation source code]]
  Read info about submitting patches (in the GUIX VM):
  #+begin_src sh
  info "(guix)Submitting Patches"
  #+end_src

* QEMU shrink disk size - doesn't work
  https://pve.proxmox.com/wiki/Shrink_Qcow2_Disk_Files
  #+begin_src sh
  dd if=/dev/zero of=mytempfile
  # that could take a some time
  sync
  rm -f mytempfile

  cp guix-system-vm-image-1.3.0.x86_64-linux.qcow2 guix-system-vm-image-1.3.0.x86_64-linux.qcow2.backup
  qemu-img convert -O qcow2 guix-system-vm-image-1.3.0.x86_64-linux.qcow2.backup guix-system-vm-image-1.3.0.x86_64-linux.qcow2
  #+end_src


  Guile Script portability across Linux and Guix machines:
  22.08.2021: [[https://logs.guix.gnu.org/guix/2021-08-22.log#115020][<leoprikler>bost: nope, only reliable shebang still is #!/bin/sh]]
